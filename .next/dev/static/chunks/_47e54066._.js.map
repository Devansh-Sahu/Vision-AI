{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/components/ui/card.tsx"],"sourcesContent":["import * as React from 'react'\n\nimport { cn } from '@/lib/utils'\n\nfunction Card({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card\"\n      className={cn(\n        'bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm',\n        className,\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardHeader({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card-header\"\n      className={cn(\n        '@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6',\n        className,\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardTitle({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card-title\"\n      className={cn('leading-none font-semibold', className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardDescription({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card-description\"\n      className={cn('text-muted-foreground text-sm', className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardAction({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card-action\"\n      className={cn(\n        'col-start-2 row-span-2 row-start-1 self-start justify-self-end',\n        className,\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardContent({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card-content\"\n      className={cn('px-6', className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardFooter({ className, ...props }: React.ComponentProps<'div'>) {\n  return (\n    <div\n      data-slot=\"card-footer\"\n      className={cn('flex items-center px-6 [.border-t]:pt-6', className)}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardAction,\n  CardDescription,\n  CardContent,\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAEA;;;AAEA,SAAS,KAAK,EAAE,SAAS,EAAE,GAAG,OAAoC;IAChE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,qFACA;QAED,GAAG,KAAK;;;;;;AAGf;KAXS;AAaT,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,4JACA;QAED,GAAG,KAAK;;;;;;AAGf;MAXS;AAaT,SAAS,UAAU,EAAE,SAAS,EAAE,GAAG,OAAoC;IACrE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGf;MARS;AAUT,SAAS,gBAAgB,EAAE,SAAS,EAAE,GAAG,OAAoC;IAC3E,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGf;MARS;AAUT,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,kEACA;QAED,GAAG,KAAK;;;;;;AAGf;MAXS;AAaT,SAAS,YAAY,EAAE,SAAS,EAAE,GAAG,OAAoC;IACvE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,QAAQ;QACrB,GAAG,KAAK;;;;;;AAGf;MARS;AAUT,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,2CAA2C;QACxD,GAAG,KAAK;;;;;;AAGf;MARS"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/components/ui/badge.tsx"],"sourcesContent":["import * as React from 'react'\nimport { Slot } from '@radix-ui/react-slot'\nimport { cva, type VariantProps } from 'class-variance-authority'\n\nimport { cn } from '@/lib/utils'\n\nconst badgeVariants = cva(\n  'inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden',\n  {\n    variants: {\n      variant: {\n        default:\n          'border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90',\n        secondary:\n          'border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90',\n        destructive:\n          'border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',\n        outline:\n          'text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground',\n      },\n    },\n    defaultVariants: {\n      variant: 'default',\n    },\n  },\n)\n\nfunction Badge({\n  className,\n  variant,\n  asChild = false,\n  ...props\n}: React.ComponentProps<'span'> &\n  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : 'span'\n\n  return (\n    <Comp\n      data-slot=\"badge\"\n      className={cn(badgeVariants({ variant }), className)}\n      {...props}\n    />\n  )\n}\n\nexport { Badge, badgeVariants }\n"],"names":[],"mappings":";;;;;;;AACA;AACA;AAEA;;;;;AAEA,MAAM,gBAAgB,IAAA,0KAAG,EACvB,kZACA;IACE,UAAU;QACR,SAAS;YACP,SACE;YACF,WACE;YACF,aACE;YACF,SACE;QACJ;IACF;IACA,iBAAiB;QACf,SAAS;IACX;AACF;AAGF,SAAS,MAAM,EACb,SAAS,EACT,OAAO,EACP,UAAU,KAAK,EACf,GAAG,OAEuD;IAC1D,MAAM,OAAO,UAAU,2KAAI,GAAG;IAE9B,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,cAAc;YAAE;QAAQ,IAAI;QACzC,GAAG,KAAK;;;;;;AAGf;KAhBS"}},
    {"offset": {"line": 176, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/components/ui/switch.tsx"],"sourcesContent":["'use client'\n\nimport * as React from 'react'\nimport * as SwitchPrimitive from '@radix-ui/react-switch'\n\nimport { cn } from '@/lib/utils'\n\nfunction Switch({\n  className,\n  ...props\n}: React.ComponentProps<typeof SwitchPrimitive.Root>) {\n  return (\n    <SwitchPrimitive.Root\n      data-slot=\"switch\"\n      className={cn(\n        'peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',\n        className,\n      )}\n      {...props}\n    >\n      <SwitchPrimitive.Thumb\n        data-slot=\"switch-thumb\"\n        className={\n          'bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0'\n        }\n      />\n    </SwitchPrimitive.Root>\n  )\n}\n\nexport { Switch }\n"],"names":[],"mappings":";;;;;AAGA;AAEA;AALA;;;;AAOA,SAAS,OAAO,EACd,SAAS,EACT,GAAG,OAC+C;IAClD,qBACE,6LAAC,6KAAoB;QACnB,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,6WACA;QAED,GAAG,KAAK;kBAET,cAAA,6LAAC,8KAAqB;YACpB,aAAU;YACV,WACE;;;;;;;;;;;AAKV;KArBS"}},
    {"offset": {"line": 217, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/components/ui/label.tsx"],"sourcesContent":["'use client'\n\nimport * as React from 'react'\nimport * as LabelPrimitive from '@radix-ui/react-label'\n\nimport { cn } from '@/lib/utils'\n\nfunction Label({\n  className,\n  ...props\n}: React.ComponentProps<typeof LabelPrimitive.Root>) {\n  return (\n    <LabelPrimitive.Root\n      data-slot=\"label\"\n      className={cn(\n        'flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50',\n        className,\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Label }\n"],"names":[],"mappings":";;;;;AAGA;AAEA;AALA;;;;AAOA,SAAS,MAAM,EACb,SAAS,EACT,GAAG,OAC8C;IACjD,qBACE,6LAAC,4KAAmB;QAClB,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,uNACA;QAED,GAAG,KAAK;;;;;;AAGf;KAdS"}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/components/ui/progress.tsx"],"sourcesContent":["'use client'\n\nimport * as React from 'react'\nimport * as ProgressPrimitive from '@radix-ui/react-progress'\n\nimport { cn } from '@/lib/utils'\n\nfunction Progress({\n  className,\n  value,\n  ...props\n}: React.ComponentProps<typeof ProgressPrimitive.Root>) {\n  return (\n    <ProgressPrimitive.Root\n      data-slot=\"progress\"\n      className={cn(\n        'bg-primary/20 relative h-2 w-full overflow-hidden rounded-full',\n        className,\n      )}\n      {...props}\n    >\n      <ProgressPrimitive.Indicator\n        data-slot=\"progress-indicator\"\n        className=\"bg-primary h-full w-full flex-1 transition-all\"\n        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n      />\n    </ProgressPrimitive.Root>\n  )\n}\n\nexport { Progress }\n"],"names":[],"mappings":";;;;;AAGA;AAEA;AALA;;;;AAOA,SAAS,SAAS,EAChB,SAAS,EACT,KAAK,EACL,GAAG,OACiD;IACpD,qBACE,6LAAC,+KAAsB;QACrB,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,kEACA;QAED,GAAG,KAAK;kBAET,cAAA,6LAAC,oLAA2B;YAC1B,aAAU;YACV,WAAU;YACV,OAAO;gBAAE,WAAW,CAAC,YAAY,EAAE,MAAM,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC;YAAC;;;;;;;;;;;AAIlE;KArBS"}},
    {"offset": {"line": 294, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/lib/dvse/engine.ts"],"sourcesContent":["// Vision-AI Safety Engine (VASE) - Core Engine Logic\n\nimport type { DVSERiskAssessment, DrowsinessMetrics, HazardDetection, SafetyStatus, AlertnessWindow } from \"@/lib/types\"\n\n// Configuration constants\nconst CONFIG = {\n  ALERTNESS_THRESHOLD: 50, // Below this triggers alert\n  HAZARD_CONFIDENCE_THRESHOLD: 0.5, // Minimum confidence for hazard alerts\n  RISK_WEIGHTS: {\n    drowsiness: 0.6, // Drowsiness contributes 60% to risk\n    hazard: 0.4, // Hazard contributes 40% to risk\n  },\n  ALERTNESS_WINDOW_SIZE: 20, // Rolling window for smoothing (10 seconds at 2 fps)\n  CRITICAL_HAZARDS: [\"cow\", \"buffalo\", \"elephant\", \"wrong_way_vehicle\", \"pedestrian\", \"broken_vehicle\"],\n  HIGH_RISK_THRESHOLD: 70,\n  CAUTION_THRESHOLD: 40,\n}\n\n// Create rolling window for smoothed alertness\nexport function createAlertnessWindow(size: number = CONFIG.ALERTNESS_WINDOW_SIZE): AlertnessWindow {\n  return {\n    samples: [],\n    windowSize: size,\n    average: 100, // Start optimistic\n  }\n}\n\n// Update rolling window with new alertness sample\nexport function updateAlertnessWindow(window: AlertnessWindow, newSample: number): AlertnessWindow {\n  const newSamples = [...window.samples, newSample]\n  if (newSamples.length > window.windowSize) {\n    newSamples.shift()\n  }\n  const average = newSamples.reduce((a, b) => a + b, 0) / newSamples.length\n  return {\n    ...window,\n    samples: newSamples,\n    average,\n  }\n}\n\n// Calculate Eye Aspect Ratio (EAR) from landmarks\nexport function calculateEAR(eyePoints: { x: number; y: number }[]): number {\n  if (eyePoints.length < 6) return 0.3 // Default open\n\n  // Vertical distances\n  const v1 = Math.sqrt(Math.pow(eyePoints[1].x - eyePoints[5].x, 2) + Math.pow(eyePoints[1].y - eyePoints[5].y, 2))\n  const v2 = Math.sqrt(Math.pow(eyePoints[2].x - eyePoints[4].x, 2) + Math.pow(eyePoints[2].y - eyePoints[4].y, 2))\n\n  // Horizontal distance\n  const h = Math.sqrt(Math.pow(eyePoints[0].x - eyePoints[3].x, 2) + Math.pow(eyePoints[0].y - eyePoints[3].y, 2))\n\n  if (h === 0) return 0.3\n  return (v1 + v2) / (2.0 * h)\n}\n\n// Convert EAR to alertness score (0-100)\nexport function earToAlertness(ear: number): number {\n  // EAR typically ranges from 0.15 (closed) to 0.35 (open)\n  const minEAR = 0.15\n  const maxEAR = 0.35\n  const normalized = Math.max(0, Math.min(1, (ear - minEAR) / (maxEAR - minEAR)))\n  return Math.round(normalized * 100)\n}\n\n// Get hazard severity based on class and confidence\nexport function getHazardSeverity(objectClass: string, confidence: number): \"critical\" | \"high\" | \"medium\" | \"low\" {\n  const isCriticalClass = CONFIG.CRITICAL_HAZARDS.includes(objectClass)\n\n  if (isCriticalClass && confidence > 0.8) return \"critical\"\n  if (isCriticalClass && confidence > 0.6) return \"high\"\n  if (confidence > 0.8) return \"high\"\n  if (confidence > 0.6) return \"medium\"\n  return \"low\"\n}\n\n// Calculate hazard risk score from detections\nexport function calculateHazardRisk(hazards: HazardDetection[]): number {\n  if (hazards.length === 0) return 0\n\n  let maxRisk = 0\n  for (const hazard of hazards) {\n    let risk = hazard.confidence * 100\n\n    // Boost risk for critical hazards\n    if (CONFIG.CRITICAL_HAZARDS.includes(hazard.objectClass)) {\n      risk = Math.min(100, risk * 1.3)\n    }\n\n    // Severity multiplier\n    const severityMultiplier = {\n      critical: 1.0,\n      high: 0.8,\n      medium: 0.5,\n      low: 0.3,\n    }\n    risk *= severityMultiplier[hazard.severity]\n\n    maxRisk = Math.max(maxRisk, risk)\n  }\n\n  return Math.round(maxRisk)\n}\n\n// Main VASE risk assessment function\nexport function assessRisk(\n  drowsiness: DrowsinessMetrics | null,\n  hazards: HazardDetection[],\n  smoothedAlertness: number,\n): DVSERiskAssessment {\n  // Calculate individual risks\n  const alertnessRisk = drowsiness ? Math.max(0, 100 - smoothedAlertness) : 0\n  const hazardRisk = calculateHazardRisk(hazards)\n\n  // Combined risk score (weighted)\n  const riskScore = Math.round(alertnessRisk * CONFIG.RISK_WEIGHTS.drowsiness + hazardRisk * CONFIG.RISK_WEIGHTS.hazard)\n\n  // Determine overall status\n  let overallStatus: SafetyStatus = \"safe\"\n  if (riskScore >= CONFIG.HIGH_RISK_THRESHOLD) {\n    overallStatus = \"high-risk\"\n  } else if (riskScore >= CONFIG.CAUTION_THRESHOLD) {\n    overallStatus = \"caution\"\n  }\n\n  // Determine if alert should trigger\n  const shouldAlert =\n    smoothedAlertness < CONFIG.ALERTNESS_THRESHOLD ||\n    hazards.some((h) => h.severity === \"critical\" || h.severity === \"high\")\n\n  // Generate alert message\n  let alertMessage: string | null = null\n  if (shouldAlert) {\n    if (smoothedAlertness < CONFIG.ALERTNESS_THRESHOLD && hazards.length > 0) {\n      alertMessage = `DANGER: Drowsy driving detected + ${hazards[0].objectClass} on road!`\n    } else if (smoothedAlertness < CONFIG.ALERTNESS_THRESHOLD) {\n      alertMessage = \"ALERT: Drowsiness detected - Please take a break!\"\n    } else if (hazards.length > 0) {\n      const criticalHazard = hazards.find((h) => h.severity === \"critical\")\n      if (criticalHazard) {\n        alertMessage = `DANGER: ${criticalHazard.objectClass.replace(\"_\", \" \")} detected ahead!`\n      } else {\n        alertMessage = `WARNING: ${hazards[0].objectClass.replace(\"_\", \" \")} detected on road`\n      }\n    }\n  }\n\n  return {\n    overallStatus,\n    riskScore,\n    alertnessRisk,\n    hazardRisk,\n    timestamp: Date.now(),\n    shouldAlert,\n    alertMessage,\n  }\n}\n\n// Get status color for UI\nexport function getStatusColor(status: SafetyStatus): string {\n  switch (status) {\n    case \"safe\":\n      return \"text-success\"\n    case \"caution\":\n      return \"text-warning\"\n    case \"high-risk\":\n      return \"text-destructive\"\n  }\n}\n\nexport function getStatusBgColor(status: SafetyStatus): string {\n  switch (status) {\n    case \"safe\":\n      return \"bg-success\"\n    case \"caution\":\n      return \"bg-warning\"\n    case \"high-risk\":\n      return \"bg-destructive\"\n  }\n}\n"],"names":[],"mappings":"AAAA,qDAAqD;;;;;;;;;;;;;;;;;;;;;AAIrD,0BAA0B;AAC1B,MAAM,SAAS;IACb,qBAAqB;IACrB,6BAA6B;IAC7B,cAAc;QACZ,YAAY;QACZ,QAAQ;IACV;IACA,uBAAuB;IACvB,kBAAkB;QAAC;QAAO;QAAW;QAAY;QAAqB;QAAc;KAAiB;IACrG,qBAAqB;IACrB,mBAAmB;AACrB;AAGO,SAAS,sBAAsB,OAAe,OAAO,qBAAqB;IAC/E,OAAO;QACL,SAAS,EAAE;QACX,YAAY;QACZ,SAAS;IACX;AACF;AAGO,SAAS,sBAAsB,MAAuB,EAAE,SAAiB;IAC9E,MAAM,aAAa;WAAI,OAAO,OAAO;QAAE;KAAU;IACjD,IAAI,WAAW,MAAM,GAAG,OAAO,UAAU,EAAE;QACzC,WAAW,KAAK;IAClB;IACA,MAAM,UAAU,WAAW,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,GAAG,KAAK,WAAW,MAAM;IACzE,OAAO;QACL,GAAG,MAAM;QACT,SAAS;QACT;IACF;AACF;AAGO,SAAS,aAAa,SAAqC;IAChE,IAAI,UAAU,MAAM,GAAG,GAAG,OAAO,IAAI,eAAe;;IAEpD,qBAAqB;IACrB,MAAM,KAAK,KAAK,IAAI,CAAC,KAAK,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,KAAK,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,EAAE;IAC9G,MAAM,KAAK,KAAK,IAAI,CAAC,KAAK,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,KAAK,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,EAAE;IAE9G,sBAAsB;IACtB,MAAM,IAAI,KAAK,IAAI,CAAC,KAAK,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,KAAK,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,EAAE;IAE7G,IAAI,MAAM,GAAG,OAAO;IACpB,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC;AAC7B;AAGO,SAAS,eAAe,GAAW;IACxC,yDAAyD;IACzD,MAAM,SAAS;IACf,MAAM,SAAS;IACf,MAAM,aAAa,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,GAAG,CAAC,MAAM,MAAM,IAAI,CAAC,SAAS,MAAM;IAC5E,OAAO,KAAK,KAAK,CAAC,aAAa;AACjC;AAGO,SAAS,kBAAkB,WAAmB,EAAE,UAAkB;IACvE,MAAM,kBAAkB,OAAO,gBAAgB,CAAC,QAAQ,CAAC;IAEzD,IAAI,mBAAmB,aAAa,KAAK,OAAO;IAChD,IAAI,mBAAmB,aAAa,KAAK,OAAO;IAChD,IAAI,aAAa,KAAK,OAAO;IAC7B,IAAI,aAAa,KAAK,OAAO;IAC7B,OAAO;AACT;AAGO,SAAS,oBAAoB,OAA0B;IAC5D,IAAI,QAAQ,MAAM,KAAK,GAAG,OAAO;IAEjC,IAAI,UAAU;IACd,KAAK,MAAM,UAAU,QAAS;QAC5B,IAAI,OAAO,OAAO,UAAU,GAAG;QAE/B,kCAAkC;QAClC,IAAI,OAAO,gBAAgB,CAAC,QAAQ,CAAC,OAAO,WAAW,GAAG;YACxD,OAAO,KAAK,GAAG,CAAC,KAAK,OAAO;QAC9B;QAEA,sBAAsB;QACtB,MAAM,qBAAqB;YACzB,UAAU;YACV,MAAM;YACN,QAAQ;YACR,KAAK;QACP;QACA,QAAQ,kBAAkB,CAAC,OAAO,QAAQ,CAAC;QAE3C,UAAU,KAAK,GAAG,CAAC,SAAS;IAC9B;IAEA,OAAO,KAAK,KAAK,CAAC;AACpB;AAGO,SAAS,WACd,UAAoC,EACpC,OAA0B,EAC1B,iBAAyB;IAEzB,6BAA6B;IAC7B,MAAM,gBAAgB,aAAa,KAAK,GAAG,CAAC,GAAG,MAAM,qBAAqB;IAC1E,MAAM,aAAa,oBAAoB;IAEvC,iCAAiC;IACjC,MAAM,YAAY,KAAK,KAAK,CAAC,gBAAgB,OAAO,YAAY,CAAC,UAAU,GAAG,aAAa,OAAO,YAAY,CAAC,MAAM;IAErH,2BAA2B;IAC3B,IAAI,gBAA8B;IAClC,IAAI,aAAa,OAAO,mBAAmB,EAAE;QAC3C,gBAAgB;IAClB,OAAO,IAAI,aAAa,OAAO,iBAAiB,EAAE;QAChD,gBAAgB;IAClB;IAEA,oCAAoC;IACpC,MAAM,cACJ,oBAAoB,OAAO,mBAAmB,IAC9C,QAAQ,IAAI,CAAC,CAAC,IAAM,EAAE,QAAQ,KAAK,cAAc,EAAE,QAAQ,KAAK;IAElE,yBAAyB;IACzB,IAAI,eAA8B;IAClC,IAAI,aAAa;QACf,IAAI,oBAAoB,OAAO,mBAAmB,IAAI,QAAQ,MAAM,GAAG,GAAG;YACxE,eAAe,CAAC,kCAAkC,EAAE,OAAO,CAAC,EAAE,CAAC,WAAW,CAAC,SAAS,CAAC;QACvF,OAAO,IAAI,oBAAoB,OAAO,mBAAmB,EAAE;YACzD,eAAe;QACjB,OAAO,IAAI,QAAQ,MAAM,GAAG,GAAG;YAC7B,MAAM,iBAAiB,QAAQ,IAAI,CAAC,CAAC,IAAM,EAAE,QAAQ,KAAK;YAC1D,IAAI,gBAAgB;gBAClB,eAAe,CAAC,QAAQ,EAAE,eAAe,WAAW,CAAC,OAAO,CAAC,KAAK,KAAK,gBAAgB,CAAC;YAC1F,OAAO;gBACL,eAAe,CAAC,SAAS,EAAE,OAAO,CAAC,EAAE,CAAC,WAAW,CAAC,OAAO,CAAC,KAAK,KAAK,iBAAiB,CAAC;YACxF;QACF;IACF;IAEA,OAAO;QACL;QACA;QACA;QACA;QACA,WAAW,KAAK,GAAG;QACnB;QACA;IACF;AACF;AAGO,SAAS,eAAe,MAAoB;IACjD,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;IACX;AACF;AAEO,SAAS,iBAAiB,MAAoB;IACnD,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;IACX;AACF"}},
    {"offset": {"line": 472, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/lib/models.ts"],"sourcesContent":["// lib/models.ts\r\n// Self-hosted TFJS FaceMesh + MediaPipe Object Detector\r\n\r\nimport * as tf from \"@tensorflow/tfjs\"\r\nimport { ObjectDetector, FilesetResolver } from \"@mediapipe/tasks-vision\"\r\n\r\nlet faceMeshModel: tf.GraphModel | null = null\r\nlet modelsLoaded = false\r\n\r\nlet faceMeshLoadingPromise: Promise<void> | null = null\r\n\r\n// -------------------------------\r\n// Load MediaPipe Object Detector\r\n// -------------------------------\r\n\r\nlet objectDetector: ObjectDetector | null = null\r\nlet objectLoadingPromise: Promise<void> | null = null\r\n\r\nexport async function loadModels() {\r\n  if (modelsLoaded) return\r\n  if (typeof window === \"undefined\") return\r\n  if (objectLoadingPromise) return objectLoadingPromise\r\n\r\n  objectLoadingPromise = (async () => {\r\n    try {\r\n      const vision = await FilesetResolver.forVisionTasks(\r\n        \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm\"\r\n      );\r\n\r\n      // Use Lite0 for maximum speed (user requested \"highly fast\")\r\n      objectDetector = await ObjectDetector.createFromOptions(vision, {\r\n        baseOptions: {\r\n          modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float32/1/efficientdet_lite0.tflite`,\r\n          delegate: \"GPU\"\r\n        },\r\n        scoreThreshold: 0.25, // Lower threshold to detect small/far animals\r\n        runningMode: \"VIDEO\"\r\n      });\r\n\r\n      console.log(\"MediaPipe EfficientDet-Lite0 loaded\")\r\n      modelsLoaded = true\r\n    } catch (err) {\r\n      console.error(\"Error loading MediaPipe Detector:\", err)\r\n    }\r\n  })()\r\n\r\n  return objectLoadingPromise\r\n}\r\n\r\nexport function getObjectDetector() {\r\n  return objectDetector\r\n}\r\n\r\n// ----------------------------------------\r\n// Load FaceMesh graph model (self-hosted)\r\n// ----------------------------------------\r\nexport async function ensureFaceMeshLoaded() {\r\n  if (faceMeshModel) return\r\n  if (typeof window === \"undefined\") return\r\n  if (faceMeshLoadingPromise) return faceMeshLoadingPromise\r\n\r\n  faceMeshLoadingPromise = (async () => {\r\n    try {\r\n\r\n\r\n      faceMeshModel = await tf.loadGraphModel(\r\n        \"/models/facemesh/model.json\",\r\n        { fromTFHub: false }\r\n      )\r\n\r\n      console.log(\"FaceMesh model loaded (local)\")\r\n    } catch (err) {\r\n      console.error(\"Failed to load FaceMesh:\", err)\r\n      faceMeshModel = null\r\n    }\r\n  })()\r\n\r\n  return faceMeshLoadingPromise\r\n}\r\n\r\nexport function getFaceMeshModel() {\r\n  return faceMeshModel\r\n}\r\n\r\n// -----------------------------------------------\r\n// Run FaceMesh inference and return raw tensors\r\n// -----------------------------------------------\r\nexport async function runFaceMesh(video: HTMLVideoElement) {\r\n  if (!faceMeshModel) return null\r\n\r\n  try {\r\n    const input = tf.tidy(() => {\r\n      return tf.browser.fromPixels(video)\r\n        .resizeBilinear([192, 192])\r\n        .expandDims(0)\r\n        .toFloat()\r\n        .div(127.5)\r\n        .sub(1) // Normalize to [-1, 1]\r\n    })\r\n\r\n    // Get model output using the correct output names from the model\r\n    // Using execute() instead of executeAsync() since we don't have dynamic output shapes\r\n    const outputs = faceMeshModel.execute(input, [\r\n      'Identity_2', // output_mesh (landmarks)\r\n      'Identity_1', // output_faceflag (confidence)\r\n      'Identity'    // output_contours\r\n    ]) as tf.Tensor[]\r\n\r\n    // Clean up input tensor\r\n    input.dispose()\r\n\r\n    try {\r\n      // Convert to arrays for debugging\r\n      const [landmarksData, faceFlagData] = await Promise.all([\r\n        outputs[0].array() as Promise<number[][]>,\r\n        outputs[1].array() as Promise<number[][]>\r\n      ])\r\n\r\n      // Clean up output tensors\r\n      outputs.forEach(t => t.dispose())\r\n\r\n      // Check for valid output\r\n      if (!landmarksData?.[0] || !faceFlagData?.[0]) {\r\n        console.warn('No face detected or invalid output format')\r\n        return null\r\n      }\r\n\r\n      // Return the raw tensors for further processing\r\n      // Convert to tensors with proper shapes\r\n      const landmarksTensor = tf.tensor2d(landmarksData, [landmarksData.length, landmarksData[0].length])\r\n      const confidenceTensor = tf.tensor1d(faceFlagData[0])\r\n\r\n      return [landmarksTensor, confidenceTensor]\r\n    } catch (error) {\r\n      console.error('Error processing face mesh output:', error)\r\n      // Ensure cleanup on error\r\n      for (const t of outputs) {\r\n        try {\r\n          t.dispose()\r\n        } catch (e) {\r\n          console.warn('Error disposing tensor:', e)\r\n        }\r\n      }\r\n      return null\r\n    }\r\n  } catch (error) {\r\n    console.error('Error in runFaceMesh:', error)\r\n    return null\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,gBAAgB;AAChB,wDAAwD;;;;;;;;;;;;;AAExD;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;AAEA,IAAI,gBAAsC;AAC1C,IAAI,eAAe;AAEnB,IAAI,yBAA+C;AAEnD,kCAAkC;AAClC,iCAAiC;AACjC,kCAAkC;AAElC,IAAI,iBAAwC;AAC5C,IAAI,uBAA6C;AAE1C,eAAe;IACpB,IAAI,cAAc;IAClB;;IACA,IAAI,sBAAsB,OAAO;IAEjC,uBAAuB,CAAC;QACtB,IAAI;YACF,MAAM,SAAS,MAAM,sLAAe,CAAC,cAAc,CACjD;YAGF,6DAA6D;YAC7D,iBAAiB,MAAM,qLAAc,CAAC,iBAAiB,CAAC,QAAQ;gBAC9D,aAAa;oBACX,gBAAgB,CAAC,sHAAsH,CAAC;oBACxI,UAAU;gBACZ;gBACA,gBAAgB;gBAChB,aAAa;YACf;YAEA,QAAQ,GAAG,CAAC;YACZ,eAAe;QACjB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,qCAAqC;QACrD;IACF,CAAC;IAED,OAAO;AACT;AAEO,SAAS;IACd,OAAO;AACT;AAKO,eAAe;IACpB,IAAI,eAAe;IACnB;;IACA,IAAI,wBAAwB,OAAO;IAEnC,yBAAyB,CAAC;QACxB,IAAI;YAGF,gBAAgB,MAAM,uLAAiB,CACrC,+BACA;gBAAE,WAAW;YAAM;YAGrB,QAAQ,GAAG,CAAC;QACd,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,gBAAgB;QAClB;IACF,CAAC;IAED,OAAO;AACT;AAEO,SAAS;IACd,OAAO;AACT;AAKO,eAAe,YAAY,KAAuB;IACvD,IAAI,CAAC,eAAe,OAAO;IAE3B,IAAI;QACF,MAAM,QAAQ,0KAAO,CAAC;YACpB,OAAO,uNAAU,CAAC,UAAU,CAAC,OAC1B,cAAc,CAAC;gBAAC;gBAAK;aAAI,EACzB,UAAU,CAAC,GACX,OAAO,GACP,GAAG,CAAC,OACJ,GAAG,CAAC,GAAG,uBAAuB;;QACnC;QAEA,iEAAiE;QACjE,sFAAsF;QACtF,MAAM,UAAU,cAAc,OAAO,CAAC,OAAO;YAC3C;YACA;YACA,WAAc,kBAAkB;SACjC;QAED,wBAAwB;QACxB,MAAM,OAAO;QAEb,IAAI;YACF,kCAAkC;YAClC,MAAM,CAAC,eAAe,aAAa,GAAG,MAAM,QAAQ,GAAG,CAAC;gBACtD,OAAO,CAAC,EAAE,CAAC,KAAK;gBAChB,OAAO,CAAC,EAAE,CAAC,KAAK;aACjB;YAED,0BAA0B;YAC1B,QAAQ,OAAO,CAAC,CAAA,IAAK,EAAE,OAAO;YAE9B,yBAAyB;YACzB,IAAI,CAAC,eAAe,CAAC,EAAE,IAAI,CAAC,cAAc,CAAC,EAAE,EAAE;gBAC7C,QAAQ,IAAI,CAAC;gBACb,OAAO;YACT;YAEA,gDAAgD;YAChD,wCAAwC;YACxC,MAAM,kBAAkB,sLAAW,CAAC,eAAe;gBAAC,cAAc,MAAM;gBAAE,aAAa,CAAC,EAAE,CAAC,MAAM;aAAC;YAClG,MAAM,mBAAmB,sLAAW,CAAC,YAAY,CAAC,EAAE;YAEpD,OAAO;gBAAC;gBAAiB;aAAiB;QAC5C,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sCAAsC;YACpD,0BAA0B;YAC1B,KAAK,MAAM,KAAK,QAAS;gBACvB,IAAI;oBACF,EAAE,OAAO;gBACX,EAAE,OAAO,GAAG;oBACV,QAAQ,IAAI,CAAC,2BAA2B;gBAC1C;YACF;YACA,OAAO;QACT;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO;IACT;AACF"}},
    {"offset": {"line": 619, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/lib/sounds.ts"],"sourcesContent":["// Soft alert sound (using Web Audio API for better control)\nclass AlertSound {\n  private audioContext: AudioContext | null = null;\n  private oscillator: OscillatorNode | null = null;\n  private gainNode: GainNode | null = null;\n  \n  constructor() {\n    // Initialize audio context on user interaction\n    if (typeof window !== 'undefined') {\n      window.addEventListener('click', this.initAudio, { once: true });\n    }\n  }\n\n  private initAudio = () => {\n    if (this.audioContext) return;\n    \n    try {\n      this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      this.gainNode = this.audioContext.createGain();\n      this.gainNode.gain.value = 0.3; // 30% volume\n      this.gainNode.connect(this.audioContext.destination);\n    } catch (e) {\n      console.warn('Web Audio API not supported', e);\n    }\n  };\n\n  play() {\n    if (!this.audioContext) this.initAudio();\n    if (!this.audioContext || !this.gainNode) return;\n\n    // Stop any existing sound\n    if (this.oscillator) {\n      this.oscillator.stop();\n    }\n\n    // Create oscillator for the alert sound\n    this.oscillator = this.audioContext.createOscillator();\n    this.oscillator.type = 'sine';\n    this.oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime); // A5 note\n    this.oscillator.frequency.exponentialRampToValueAtTime(\n      440, \n      this.audioContext.currentTime + 0.5 // Ramp down to A4 over 0.5s\n    );\n    \n    // Connect and play\n    this.oscillator.connect(this.gainNode);\n    this.oscillator.start();\n    this.oscillator.stop(this.audioContext.currentTime + 1); // Stop after 1 second\n  }\n}\n\nexport const alertSound = new AlertSound();\n"],"names":[],"mappings":"AAAA,4DAA4D;;;;;AAC5D,MAAM;IACI,eAAoC,KAAK;IACzC,aAAoC,KAAK;IACzC,WAA4B,KAAK;IAEzC,aAAc;QACZ,+CAA+C;QAC/C,wCAAmC;YACjC,OAAO,gBAAgB,CAAC,SAAS,IAAI,CAAC,SAAS,EAAE;gBAAE,MAAM;YAAK;QAChE;IACF;IAEQ,YAAY;QAClB,IAAI,IAAI,CAAC,YAAY,EAAE;QAEvB,IAAI;YACF,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,OAAO,YAAY,IAAI,AAAC,OAAe,kBAAkB;YAClF,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,UAAU;YAC5C,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,GAAG,KAAK,aAAa;YAC7C,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,WAAW;QACrD,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,+BAA+B;QAC9C;IACF,EAAE;IAEF,OAAO;QACL,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS;QACtC,IAAI,CAAC,IAAI,CAAC,YAAY,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;QAE1C,0BAA0B;QAC1B,IAAI,IAAI,CAAC,UAAU,EAAE;YACnB,IAAI,CAAC,UAAU,CAAC,IAAI;QACtB;QAEA,wCAAwC;QACxC,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,YAAY,CAAC,gBAAgB;QACpD,IAAI,CAAC,UAAU,CAAC,IAAI,GAAG;QACvB,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,cAAc,CAAC,KAAK,IAAI,CAAC,YAAY,CAAC,WAAW,GAAG,UAAU;QACxF,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,4BAA4B,CACpD,KACA,IAAI,CAAC,YAAY,CAAC,WAAW,GAAG,IAAI,4BAA4B;;QAGlE,mBAAmB;QACnB,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ;QACrC,IAAI,CAAC,UAAU,CAAC,KAAK;QACrB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,WAAW,GAAG,IAAI,sBAAsB;IACjF;AACF;AAEO,MAAM,aAAa,IAAI"}},
    {"offset": {"line": 674, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/lib/biometric-eye-model.ts"],"sourcesContent":["import { DrowsinessMetrics } from \"./types\"\r\n\r\n// --- Constants & Config ---\r\n\r\nconst LANDMARKS = {\r\n    // Standard 6-point eye definition for MediaPipe FaceMesh\r\n    // P1: Left Corner, P2: Top Outer, P3: Top Inner, P4: Right Corner, P5: Bot Inner, P6: Bot Outer\r\n    LEFT_EYE: [33, 160, 158, 133, 153, 144],\r\n    RIGHT_EYE: [263, 387, 385, 362, 380, 373],\r\n}\r\n\r\ntype Point = { x: number; y: number; z?: number }\r\n\r\ninterface EyeGeometry {\r\n    ear: number\r\n    verticalDist: number\r\n    horizontalWith: number\r\n    // A measure of how much the upper lid deviates from the straight line connecting corners\r\n    upperLidCurvature: number\r\n}\r\n\r\ninterface EyeStateInternal {\r\n    opennessPercent: number // 0-100\r\n    rawOpennessMetric: number // The raw fused metric before normalization\r\n    velocity: number // deg/sec or unit/sec\r\n    isBlink: boolean\r\n    isMicrosleep: boolean\r\n    isDrowsy: boolean\r\n    confidence: number\r\n}\r\n\r\n/**\r\n * OneEuroFilter for signal smoothing (jitter reduction + responsiveness)\r\n */\r\nclass OneEuroFilter {\r\n    private minCutoff: number\r\n    private beta: number\r\n    private dCutoff: number\r\n    private dxPrev: number = 0\r\n    private xPrev: number | null = null\r\n    private tPrev: number | null = null\r\n\r\n    constructor(minCutoff = 1.0, beta = 0.0, dCutoff = 1.0) {\r\n        this.minCutoff = minCutoff\r\n        this.beta = beta\r\n        this.dCutoff = dCutoff\r\n    }\r\n\r\n    filter(x: number, t: number = Date.now()): number {\r\n        if (this.xPrev === null || this.tPrev === null) {\r\n            this.xPrev = x\r\n            this.tPrev = t\r\n            return x\r\n        }\r\n\r\n        const dt = (t - this.tPrev) / 1000.0\r\n        if (dt === 0) return this.xPrev // Force distinct timestamps\r\n\r\n        const a_d = this.smoothingFactor(dt, this.dCutoff)\r\n        const dx = (x - this.xPrev) / dt\r\n        const dxHat = this.exponentialSmoothing(a_d, dx, this.dxPrev)\r\n\r\n        const cutoff = this.minCutoff + this.beta * Math.abs(dxHat)\r\n        const a = this.smoothingFactor(dt, cutoff)\r\n        const xHat = this.exponentialSmoothing(a, x, this.xPrev)\r\n\r\n        this.xPrev = xHat\r\n        this.dxPrev = dxHat\r\n        this.tPrev = t\r\n        return xHat\r\n    }\r\n\r\n    private smoothingFactor(dt: number, cutoff: number): number {\r\n        const r = 2 * Math.PI * cutoff\r\n        return r * dt / (1 + r * dt)\r\n    }\r\n\r\n    private exponentialSmoothing(a: number, x: number, xPrev: number): number {\r\n        return a * x + (1 - a) * xPrev\r\n    }\r\n\r\n    reset() {\r\n        this.xPrev = null;\r\n        this.tPrev = null;\r\n        this.dxPrev = 0;\r\n    }\r\n}\r\n\r\n/**\r\n * Biometric Eye Engine\r\n * Encapsulates geometry, calibration, and temporal state.\r\n */\r\nexport class BiometricEyeEngine {\r\n    // Calibration State\r\n    // We track \"Open\" (approx 95th percentile) and \"Closed\" (absolute min during blinks)\r\n    // We use asymmetric learning rates to push boundaries\r\n    private calibration = {\r\n        openBaseline: 0.30, // Default to a healthy open eye value\r\n        closedBaseline: 0.10, // Default to fully closed\r\n        isInitialized: false,\r\n        samples: 0\r\n    }\r\n\r\n    // Filters\r\n    private opennessFilter = new OneEuroFilter(2.0, 0.01, 1.0) // More responsive, less lag\r\n    private velocityFilter = new OneEuroFilter(10.0, 0.0) // Fast response for velocity\r\n\r\n    // State Tracking\r\n    private lastMetric: number = 0.3\r\n    private lastTime: number = 0\r\n\r\n    // Event State\r\n    private blinkStartTime: number | null = null\r\n    private microsleepStartTime: number | null = null\r\n\r\n    constructor() {\r\n        this.lastTime = Date.now()\r\n    }\r\n\r\n    /**\r\n     * Main Process Loop\r\n     */\r\n    public processFrame(landmarks: Point[]): EyeStateInternal | null {\r\n        const now = Date.now()\r\n\r\n        // 1. Extract Geometry\r\n        const leftEye = this.getEyeGeometry(landmarks, LANDMARKS.LEFT_EYE)\r\n        const rightEye = this.getEyeGeometry(landmarks, LANDMARKS.RIGHT_EYE)\r\n\r\n        if (!leftEye || !rightEye) return null\r\n\r\n        // 2. Fusion Logic: Weighted average favoring stability\r\n        const avgEAR = (leftEye.ear + rightEye.ear) / 2\r\n\r\n        const rawMetric = avgEAR\r\n\r\n        // 3. Adaptive Calibration with Safety Bounds\r\n        this.updateCalibration(rawMetric)\r\n\r\n        // 4. Perceptual Normalization\r\n        // Map raw metric to 0-100% based on learnt range\r\n        const normalizedOpenness = this.computePerceptualOpenness(rawMetric)\r\n\r\n        // 5. Temporal Smoothing\r\n        const smoothedOpenness = this.opennessFilter.filter(normalizedOpenness, now)\r\n\r\n        // 6. Velocity Calculation\r\n        const dt = (now - this.lastTime) / 1000\r\n        // Only calc velocity if time progressed\r\n        let velocity = 0;\r\n        if (dt > 0) {\r\n            velocity = (smoothedOpenness - this.lastMetric) / dt\r\n        }\r\n        this.lastMetric = smoothedOpenness\r\n        this.lastTime = now\r\n\r\n        // 7. Event Detection (Blinks, Microsleeps)\r\n        const state = this.detectEvents(smoothedOpenness, velocity, now)\r\n\r\n        return {\r\n            opennessPercent: smoothedOpenness,\r\n            rawOpennessMetric: rawMetric,\r\n            velocity,\r\n            ...state\r\n        }\r\n    }\r\n\r\n    private getEyeGeometry(landmarks: Point[], indices: number[]): EyeGeometry | null {\r\n        // Need all points\r\n        const points = indices.map(i => landmarks[i])\r\n        if (points.some(p => !p)) return null\r\n\r\n        const [p1, p2, p3, p4, p5, p6] = points\r\n\r\n        // Vertical 1: p2 -> p6\r\n        const v1 = this.distance(p2, p6)\r\n        // Vertical 2: p3 -> p5\r\n        const v2 = this.distance(p3, p5)\r\n        // Horizontal: p1 -> p4\r\n        const h = this.distance(p1, p4)\r\n\r\n        if (h < 1e-4) return null // Avoid div by zero\r\n\r\n        const ear = (v1 + v2) / (2 * h)\r\n\r\n        return {\r\n            ear,\r\n            verticalDist: (v1 + v2) / 2,\r\n            horizontalWith: h,\r\n            upperLidCurvature: 0\r\n        }\r\n    }\r\n\r\n    private distance(a: Point, b: Point): number {\r\n        return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2))\r\n    }\r\n\r\n    /**\r\n     * Adapts the Open/Closed baselines over time.\r\n     * STRICT SAFETY: We prevent the baselines from \"collapsing\" (Open becoming == Closed).\r\n     * We also enforce absolute limits so \"Closed\" never looks \"Open\".\r\n     */\r\n    private updateCalibration(val: number) {\r\n        if (!this.calibration.isInitialized) {\r\n            // Initialization Phase (First 60 frames / ~2 sec)\r\n            // Just aggressively expand bounds\r\n            if (this.calibration.samples < 60) {\r\n                this.calibration.openBaseline = Math.max(0.25, Math.max(this.calibration.openBaseline, val))\r\n                this.calibration.closedBaseline = Math.min(0.15, Math.min(this.calibration.closedBaseline, val))\r\n                this.calibration.samples++\r\n                return\r\n            } else {\r\n                this.calibration.isInitialized = true\r\n            }\r\n        }\r\n\r\n        // Dynamic Learning Rates\r\n        const learnUp = 0.05   // Fast adaptation to new max\r\n        const learnDown = 0.001 // Very slow decay to prevent \"drowsy\" drift\r\n\r\n        // 1. Update Open Baseline\r\n        // Only update if value is REASONABLE (not an outlier blink, not a glitch)\r\n        // We assume legitimate \"Open\" eyes are > 0.20\r\n        if (val > 0.20) {\r\n            if (val > this.calibration.openBaseline) {\r\n                // New local max found - adapt\r\n                this.calibration.openBaseline = val * learnUp + this.calibration.openBaseline * (1 - learnUp)\r\n            } else {\r\n                // Decay very slowly\r\n                this.calibration.openBaseline = this.calibration.openBaseline - (this.calibration.openBaseline * learnDown)\r\n            }\r\n        }\r\n\r\n        // 2. Update Closed Baseline\r\n        // Only consider values that look like blinks (< 0.20)\r\n        if (val < 0.20) {\r\n            if (val < this.calibration.closedBaseline) {\r\n                // New local min found - adapt\r\n                this.calibration.closedBaseline = val * learnUp + this.calibration.closedBaseline * (1 - learnUp)\r\n            } else {\r\n                // Decay\r\n                this.calibration.closedBaseline = this.calibration.closedBaseline + (this.calibration.closedBaseline * learnDown)\r\n            }\r\n        }\r\n\r\n        // 3. STRICT SAFETY CLAMPS (The Fix)\r\n        // Absolute physically possible limits for \"generic\" human eyes\r\n        // Open eyes are rarely < 0.22 EAR. Closed eyes are rarely > 0.18 EAR.\r\n        this.calibration.openBaseline = Math.max(0.24, Math.min(0.45, this.calibration.openBaseline))\r\n        this.calibration.closedBaseline = Math.max(0.05, Math.min(0.18, this.calibration.closedBaseline))\r\n\r\n        // Ensure Enforced Separation\r\n        if (this.calibration.openBaseline - this.calibration.closedBaseline < 0.10) {\r\n            // Push open baseline up if they get too close\r\n            this.calibration.openBaseline = this.calibration.closedBaseline + 0.10\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Non-linear mapping from metric to 0-100 perception.\r\n     */\r\n    private computePerceptualOpenness(val: number): number {\r\n        const { openBaseline, closedBaseline } = this.calibration\r\n\r\n        // HARD FORCE CLOSED Logic\r\n        // If EAR is below 0.15, it is physically impossible to be \"Open\". \r\n        // Return 0 immediately. This fixes the \"100% when closed\" bug.\r\n        if (val < 0.15) return 0;\r\n\r\n        // 0. Clamping relative to calibration\r\n        if (val <= closedBaseline) return 0\r\n        if (val >= openBaseline) return 100\r\n\r\n        // 1. Linear normalization\r\n        let t = (val - closedBaseline) / (openBaseline - closedBaseline)\r\n\r\n        // 2. Non-linear perception curve\r\n        // We want the 0-15% range effectively mapped to \"closed/nearly closed\"\r\n        // We want 80-100% mapped to \"fully open\"\r\n\r\n        let openness = 0;\r\n        if (t < 0.2) {\r\n            openness = (t / 0.2) * 5 // 0-5% (Basically closed)\r\n        } else if (t < 0.6) {\r\n            // Critical zone: 0.2 to 0.6 maps to 5% to 70%\r\n            // This makes the drop-off steeper\r\n            openness = 5 + ((t - 0.2) / 0.4) * 65\r\n        } else {\r\n            // Open zone: 0.6 to 1.0 maps to 70% to 100%\r\n            openness = 70 + ((t - 0.6) / 0.4) * 30\r\n        }\r\n\r\n        return openness\r\n    }\r\n\r\n    private detectEvents(openness: number, velocity: number, time: number) {\r\n        let isBlink = false\r\n        let isMicrosleep = false\r\n        let isDrowsy = false\r\n        let confidence = 1.0 // Placeholder\r\n\r\n        // Blink Logic\r\n        // If openness drops below 10% quickly, it's a blink\r\n        if (openness < 15) {\r\n            if (!this.blinkStartTime) {\r\n                this.blinkStartTime = time\r\n            }\r\n            isBlink = true\r\n\r\n            // Microwave/Long Closure Logic\r\n            const duration = time - this.blinkStartTime\r\n            if (duration > 500) { // > 500ms closed\r\n                isMicrosleep = true\r\n            }\r\n        } else {\r\n            // Reset blink timer if eyes open\r\n            if (openness > 30) {\r\n                this.blinkStartTime = null\r\n            }\r\n        }\r\n\r\n        // Drowsiness Logic (Composite)\r\n        // 1. Sustained partial closure (hovering at 30-50%)\r\n        // 2. High frequency of microsleeps (external logic usually handles freq, here we handle state)\r\n        // 3. Slow eyelid velocity (droopy)\r\n\r\n        if (openness > 15 && openness < 60 && Math.abs(velocity) < 10) {\r\n            // Eyes are half open and NOT moving much -> Drowsy/Droopy\r\n            isDrowsy = true\r\n        }\r\n\r\n        // Microsleep overrides drowsy\r\n        if (isMicrosleep) {\r\n            isDrowsy = true\r\n        }\r\n\r\n        return { isBlink, isMicrosleep, isDrowsy, confidence }\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 966, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/lib/hazard-guard.ts"],"sourcesContent":["import { HazardDetection, BoundingBox } from \"@/lib/types\"\r\n\r\n// Configuration Constants\r\nconst CONFIG = {\r\n    // Region of Interest (ROI) - Static Trapezoid for highway driving\r\n    // (Assuming camera mounted at dash height, center-aligned)\r\n    ROI_TOP_Y: 0.45,    // Horizon line approx\r\n    ROI_BOTTOM_Y: 1.0,  // Bottom of frame\r\n    ROI_LEFT_X_TOP: 0.40, // Narrow at horizon\r\n    ROI_RIGHT_X_TOP: 0.60,\r\n    ROI_LEFT_X_BOTTOM: 0.0, // Full width at bottom\r\n    ROI_RIGHT_X_BOTTOM: 1.0,\r\n\r\n    // Temporal Persistence\r\n    CONFIRMATION_FRAMES_CRITICAL: 1, // Persons/Cars = immediate (if confidence high)\r\n    CONFIRMATION_FRAMES_MEDIUM: 3,   // Potholes/Debris = wait 3 frames to reject noise\r\n    TRACK_IOU_THRESHOLD: 0.3,        // Loose matching for tracking\r\n    MAX_DROPOUT_FRAMES: 2,           // Keep track alive for 2 frames if detection missed\r\n\r\n    // Size Heuristics\r\n    MIN_RELATIVE_WIDTH: 0.02, // Objects smaller than 2% of screen width are likely noise/too far\r\n    MAX_DISTANCE_Z: 150,      // Meters (Approximate)\r\n\r\n    // Logic Thresholds\r\n    EGO_LANE_CENTER_X: 0.5,\r\n    EGO_LANE_WIDTH_AT_BOTTOM: 0.6, // +/- 0.3 from center\r\n    // WRONG_WAY_VELOCITY_THRESHOLD: 0.005, // Normalized units per frame (approx) - Removed, now using isApproaching\r\n}\r\n\r\ninterface TrackedHazard {\r\n    id: string\r\n    firstSeen: number\r\n    lastSeen: number\r\n    hitCounter: number\r\n    missCounter: number\r\n    objectClass: string\r\n    box: BoundingBox\r\n    confidenceHistory: number[]\r\n    confirmed: boolean\r\n\r\n    // Motion State\r\n    velocityX: number\r\n    velocityY: number\r\n    expansionRate: number\r\n    isApproaching: boolean\r\n}\r\n\r\n/**\r\n * HazardGuard: Safety-Critical Post-Processing Filter\r\n * \r\n * Responsibilities:\r\n * 1. Reject detections outside the drivable road correlation (ROI).\r\n * 2. Track objects over time to suppress single-frame flickering (noise).\r\n * 3. Enforce size/depth constraints to ignore background objects.\r\n * 4. Filter generic vehicles unless they exhibit hazardous motion (Wrong Way).\r\n */\r\nexport class HazardGuard {\r\n    private tracks: Map<string, TrackedHazard> = new Map()\r\n    private nextTrackId = 1\r\n    private frameCount = 0\r\n\r\n    constructor() { }\r\n\r\n    public process(detections: HazardDetection[], frameWidth: number, frameHeight: number): HazardDetection[] {\r\n        this.frameCount++\r\n        const now = Date.now()\r\n\r\n        // 1. ROI & Geomtric Filtering\r\n        const validDetections = detections.filter(d => this.isValidCandidate(d))\r\n\r\n        // 2. Temporal Tracking (Sort-Pro-Lite logic)\r\n        // Predict/Associate\r\n        const matched = this.associateTracks(validDetections)\r\n\r\n        // Update Tracks\r\n        const activeTracks: HazardDetection[] = []\r\n\r\n        // A. Handle Matches\r\n        matched.matches.forEach(match => {\r\n            const track = this.tracks.get(match.trackId)!\r\n            const det = validDetections[match.detIndex]\r\n\r\n            this.updateTrack(track, det, now)\r\n\r\n            if (this.isConfirmed(track)) {\r\n                // LOGIC FILTER: Only output if it's a confirmed threat\r\n                const threatLevel = this.assessThreat(track);\r\n\r\n                if (threatLevel !== 'safe') {\r\n                    // If it was generic vehicle but now detected as wrong way, upgrade it\r\n                    let finalClass = track.objectClass;\r\n                    let finalSeverity = det.severity;\r\n\r\n                    if (threatLevel === 'wrong_way') {\r\n                        finalClass = 'wrong_way_vehicle';\r\n                        finalSeverity = 'critical';\r\n                    }\r\n\r\n                    activeTracks.push({\r\n                        ...det,\r\n                        id: `trk_${match.trackId}`,\r\n                        objectClass: finalClass as any,\r\n                        severity: finalSeverity\r\n                    })\r\n                }\r\n            }\r\n        })\r\n\r\n        // B. Handle Unmatched Detections (New Tracks)\r\n        matched.unmatchedDetections.forEach(detIndex => {\r\n            const det = validDetections[detIndex]\r\n            const newTrack = this.createTrack(det, now)\r\n\r\n            // Critical hazards might be confirmed immediately if confidence is super high\r\n            if (this.isConfirmed(newTrack)) {\r\n                // New track doesn't have velocity history yet.\r\n                // If it's explicitly generic 'vehicle', we assume safe for 1st frame to avoid flash.\r\n                // Unless explicitly 'wrong_way_vehicle'.\r\n                const threatLevel = this.assessThreat(newTrack);\r\n\r\n                if (threatLevel !== 'safe') {\r\n                    activeTracks.push({\r\n                        ...det,\r\n                        id: `trk_${newTrack.id}`\r\n                    })\r\n                }\r\n            }\r\n        })\r\n\r\n        // C. Handle Unmatched Tracks (Misses)\r\n        matched.unmatchedTracks.forEach(trackId => {\r\n            const track = this.tracks.get(trackId)!\r\n            track.missCounter++\r\n\r\n            // If confirmed and only missed briefly, keep outputting it (ghost)? \r\n            // For safety, we usually stop outputting immediately but keep memory for re-association.\r\n            // So we do NOT push to activeTracks here unless we want \"coasting\".\r\n            // Let's NOT coast for safety (avoid predicting hazards that moved).\r\n\r\n            if (track.missCounter > CONFIG.MAX_DROPOUT_FRAMES) {\r\n                this.tracks.delete(trackId)\r\n            }\r\n        })\r\n\r\n        return activeTracks\r\n    }\r\n\r\n    // --- 1. Geometric & Logic Filtering ---\r\n\r\n    private isValidCandidate(d: HazardDetection): boolean {\r\n        const box = d.bbox\r\n        const cls = d.objectClass\r\n\r\n        // 1. Size Check (Too small = likely far background or noise)\r\n        if (box.width < CONFIG.MIN_RELATIVE_WIDTH) return false\r\n\r\n        // 2. ROI Check (Drivable Corridor)\r\n        const bottomCenterX = box.x + box.width / 2\r\n        const bottomCenterY = box.y + box.height\r\n\r\n        if (!this.isInTrapezoid(bottomCenterX, bottomCenterY)) {\r\n            // EXCEPTION: Large animals entering from side might be valid even if just outside \r\n            // But strict ROI for now.\r\n            return false\r\n        }\r\n\r\n        // 3. Logic Filter: Traffic Rules\r\n        // We ALLOW generic vehicles here so we can track them to check velocity.\r\n        // Filtering happens in 'assessThreat'.\r\n        return true\r\n    }\r\n\r\n    private assessThreat(track: TrackedHazard): 'safe' | 'hazard' | 'wrong_way' {\r\n        const cls = track.objectClass;\r\n\r\n        // 1. Explicit Hazards are always hazards\r\n        if (['pothole', 'debris', 'fallen_tree', 'pedestrian', 'cow', 'animal', 'wrong_way_vehicle'].some(c => cls.includes(c))) {\r\n            return 'hazard';\r\n        }\r\n\r\n        // 2. Generic Vehicles -> Check Motion\r\n        if (this.isVehicle(cls)) {\r\n            // If explicitly labelled wrong way, trust it (if model is trusted)\r\n            if (cls === 'wrong_way_vehicle') return 'wrong_way';\r\n\r\n            // Motion Logic for generic 'vehicle' / 'car'\r\n            if (track.isApproaching) {\r\n                // Check Lane Position (Center of box relative to screen)\r\n                const centerX = track.box.x + track.box.width / 2;\r\n\r\n                // Is it in Ego Lane? (Center usually 0.5)\r\n                const distFromCenter = Math.abs(centerX - CONFIG.EGO_LANE_CENTER_X);\r\n\r\n                // Rough check: is it within the central lane corridor?\r\n                if (distFromCenter < 0.20) {\r\n                    // APPROACHING in CENTER LANE -> WRONG WAY\r\n                    return 'wrong_way';\r\n                }\r\n            }\r\n\r\n            // Otherwise, it's normal traffic (moving away or adjacent)\r\n            return 'safe';\r\n        }\r\n\r\n        // Default safe\r\n        return 'safe';\r\n    }\r\n\r\n    private isVehicle(cls: string): boolean {\r\n        return ['vehicle', 'wrong_way_vehicle', 'broken_vehicle', 'car', 'truck', 'bus', 'motorcycle'].includes(cls);\r\n    }\r\n\r\n    private isInTrapezoid(x: number, y: number): boolean {\r\n        // Check Y bounds\r\n        if (y < CONFIG.ROI_TOP_Y || y > CONFIG.ROI_BOTTOM_Y) return false\r\n\r\n        // Linearly interpolate X bounds based on Y\r\n        const progress = (y - CONFIG.ROI_TOP_Y) / (CONFIG.ROI_BOTTOM_Y - CONFIG.ROI_TOP_Y)\r\n\r\n        // Perspective correction: trapezoid widens at bottom\r\n        const minX = CONFIG.ROI_LEFT_X_TOP + (CONFIG.ROI_LEFT_X_BOTTOM - CONFIG.ROI_LEFT_X_TOP) * progress\r\n        const maxX = CONFIG.ROI_RIGHT_X_TOP + (CONFIG.ROI_RIGHT_X_BOTTOM - CONFIG.ROI_RIGHT_X_TOP) * progress\r\n\r\n        return x >= minX && x <= maxX\r\n    }\r\n\r\n    // --- 2. Temporal Tracking ---\r\n\r\n    private associateTracks(detections: HazardDetection[]) {\r\n        const matches: { trackId: string, detIndex: number }[] = []\r\n        const unmatchedDetections: number[] = []\r\n        const unmatchedTracks = new Set(this.tracks.keys())\r\n\r\n        // Greedy IOU matching\r\n        // O(N*M) is fine for N,M < 20 (typical road scene)\r\n\r\n        // Sort detections by confidence high->low\r\n        const sortedIndices = detections.map((_, i) => i).sort((a, b) => detections[b].confidence - detections[a].confidence)\r\n\r\n        for (const i of sortedIndices) {\r\n            const det = detections[i]\r\n            let bestIoU = -1\r\n            let bestTrackId = null\r\n\r\n            for (const trackId of unmatchedTracks) {\r\n                const track = this.tracks.get(trackId)!\r\n                const iou = this.computeIoU(det.bbox, track.box)\r\n                if (iou > CONFIG.TRACK_IOU_THRESHOLD && iou > bestIoU) {\r\n                    bestIoU = iou\r\n                    bestTrackId = trackId\r\n                }\r\n            }\r\n\r\n            if (bestTrackId) {\r\n                matches.push({ trackId: bestTrackId, detIndex: i })\r\n                unmatchedTracks.delete(bestTrackId)\r\n            } else {\r\n                unmatchedDetections.push(i)\r\n            }\r\n        }\r\n\r\n        return { matches, unmatchedDetections, unmatchedTracks: Array.from(unmatchedTracks) }\r\n    }\r\n\r\n    private updateTrack(track: TrackedHazard, det: HazardDetection, now: number) {\r\n        const prev = track.box;\r\n        const curr = det.bbox;\r\n\r\n        // Velocity Calculation (Simple Diff)\r\n        // Moving Down (+Y) = Approaching (usually) or Moving away slower than ego? \r\n        // In dashcam: Object getting bigger + Center Y moving down = APPROACHING\r\n\r\n        const newVelocityY = curr.y - prev.y;\r\n        const newExpansion = curr.width - prev.width;\r\n\r\n        // Smooth Velocity\r\n        track.velocityY = track.velocityY * 0.7 + newVelocityY * 0.3;\r\n        track.expansionRate = track.expansionRate * 0.7 + newExpansion * 0.3;\r\n\r\n        // Logic: Approaching if Y is increasing (moving down screen) AND Width is increasing\r\n        track.isApproaching = (track.velocityY > 0.001) && (track.expansionRate > 0.001);\r\n\r\n        track.hitCounter++\r\n        track.missCounter = 0\r\n        track.lastSeen = now\r\n        track.box = det.bbox // Update box\r\n        track.confidenceHistory.push(det.confidence)\r\n        if (track.confidenceHistory.length > 5) track.confidenceHistory.shift()\r\n    }\r\n\r\n    private createTrack(det: HazardDetection, now: number): TrackedHazard {\r\n        const id = (this.nextTrackId++).toString()\r\n        const track = {\r\n            id,\r\n            firstSeen: now,\r\n            lastSeen: now,\r\n            hitCounter: 1,\r\n            missCounter: 0,\r\n            objectClass: det.objectClass,\r\n            box: det.bbox,\r\n            confidenceHistory: [det.confidence],\r\n            confirmed: false,\r\n            velocityX: 0,\r\n            velocityY: 0,\r\n            expansionRate: 0,\r\n            isApproaching: false\r\n        }\r\n        this.tracks.set(id, track)\r\n        return track\r\n    }\r\n\r\n    private isConfirmed(track: TrackedHazard): boolean {\r\n        // Already confirmed?\r\n        if (track.confirmed) return true\r\n\r\n        const meanConf = track.confidenceHistory.reduce((a, b) => a + b, 0) / track.confidenceHistory.length\r\n\r\n        // CRITICAL: Person, Car, Truck, Cow - Confirm Fast\r\n        // We define 'critical' class set here or derive from severity\r\n        // Assuming 'objectClass' maps to existing categories\r\n        const criticalClasses = ['person', 'car', 'truck', 'bus', 'motorcycle', 'cow', 'pedestrian', 'animal_large']\r\n        const isCritical = criticalClasses.some(c => track.objectClass.includes(c))\r\n\r\n        if (isCritical) {\r\n            if (meanConf > 0.6) {\r\n                track.confirmed = true\r\n                return true\r\n            }\r\n            // If lower confidence, wait 1 more frame\r\n            if (track.hitCounter >= 2) {\r\n                track.confirmed = true\r\n                return true\r\n            }\r\n        } else {\r\n            // STANDARD: Potholes, Debris, Cones - Wait for persistence\r\n            // These are noisy. Wait for 3 frames.\r\n            if (track.hitCounter >= CONFIG.CONFIRMATION_FRAMES_MEDIUM) {\r\n                track.confirmed = true\r\n                return true\r\n            }\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    private computeIoU(b1: BoundingBox, b2: BoundingBox): number {\r\n        const x1 = Math.max(b1.x, b2.x)\r\n        const y1 = Math.max(b1.y, b2.y)\r\n        const x2 = Math.min(b1.x + b1.width, b2.x + b2.width)\r\n        const y2 = Math.min(b1.y + b1.height, b2.y + b2.height)\r\n\r\n        if (x2 < x1 || y2 < y1) return 0\r\n\r\n        const intersection = (x2 - x1) * (y2 - y1)\r\n        const area1 = b1.width * b1.height\r\n        const area2 = b2.width * b2.height\r\n\r\n        return intersection / (area1 + area2 - intersection)\r\n    }\r\n}\r\n\r\nexport const hazardGuard = new HazardGuard()\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1279, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/lib/detection.ts"],"sourcesContent":["// lib/detection.ts\nimport * as tf from \"@tensorflow/tfjs\"\nimport {\n  getFaceMeshModel,\n  ensureFaceMeshLoaded,\n  runFaceMesh,\n  getObjectDetector,\n  loadModels,\n} from \"./models\"\n\nimport type {\n  DrowsinessMetrics,\n  HazardDetection,\n  HazardObjectClass,\n  BoundingBox\n} from \"@/lib/types\"\n\nimport { alertSound } from './sounds';\nimport { BiometricEyeEngine } from \"./biometric-eye-model\"\n\n// --- Global State ---\n\nlet tfReady: Promise<void> | null = null;\n\nfunction ensureTFReady() {\n  if (!tfReady) {\n    tfReady = tf.ready();\n  }\n  return tfReady;\n}\n\n// Instantiate the engine permanently so calibration persists\nconst eyeEngine = new BiometricEyeEngine();\n\n// Tracking state for UI counters\nlet blinkCount = 0;\nlet wasBlinking = false;\nlet lastBlinkTime = 0;\n\n// Track alert state\nlet lastAlertTime = 0;\nconst ALERT_COOLDOWN = 10000;\nlet currentAlert: 'hazard' | 'drowsiness' | null = null;\nlet lastAlertType: 'hazard' | 'drowsiness' | null = null;\n\n// Reset tracking when no face is detected for a while\nlet noFaceCounter = 0;\nconst MAX_NO_FACE_FRAMES = 10;\n\n// Debug state\nconst debug = {\n  frameCount: 0\n};\n\n// --- Helper Functions ---\n\nexport function triggerAlert(type: 'hazard' | 'drowsiness') {\n  const now = Date.now();\n\n  if (type === lastAlertType && (now - lastAlertTime) < ALERT_COOLDOWN) {\n    return;\n  }\n\n  if (type !== currentAlert) {\n    alertSound.play();\n  }\n\n  currentAlert = type;\n  lastAlertType = type;\n  lastAlertTime = now;\n\n  setTimeout(() => {\n    if (currentAlert === type) {\n      currentAlert = null;\n    }\n  }, 5000);\n}\n\nexport function getCurrentAlert() {\n  return currentAlert;\n}\n\n// --- Main Drowsiness Detection ---\n\nexport async function runRealDrowsinessDetection(\n  videoEl: HTMLVideoElement | null\n): Promise<DrowsinessMetrics | null> {\n  if (!videoEl || videoEl.readyState < 2) return null\n\n  await ensureTFReady()\n  await ensureFaceMeshLoaded()\n\n  const model = getFaceMeshModel()\n  if (!model) return null\n\n  try {\n    const outputs = await runFaceMesh(videoEl)\n    if (!outputs || outputs.length < 2) return null\n\n    const [landmarksTensor, confidenceTensor] = outputs\n\n    // Process Tensors\n    const landmarksData = await landmarksTensor.array();\n    const confidenceData = await confidenceTensor.arraySync();\n\n    landmarksTensor.dispose();\n    confidenceTensor.dispose();\n\n    const landmarksArray = Array.isArray(landmarksData[0])\n      ? (landmarksData as number[][])[0]\n      : landmarksData as number[]\n\n    // Check validity\n    if (!landmarksArray || landmarksArray.length < 468 * 3) {\n      noFaceCounter++;\n      if (noFaceCounter > MAX_NO_FACE_FRAMES) {\n        // Optionally reset engine filters? eyeEngine.reset() if we implemented it\n        // For now, the engine handles time gaps natively\n      }\n      return null;\n    }\n    noFaceCounter = 0;\n\n    // Convert to Point[] {x, y, z}\n    // We only need 2D for the current engine, but z might be useful later\n    // landmarksArray comes as [x,y,z, x,y,z, ...] normalized 0-1 (usually)\n    // IMPORTANT: FaceMesh usually outputs normalized coordinates.\n    // The engine expects raw pixels OR consistent units. \n    // If we pass normalized, aspect ratio matters. \n    // The engine calculates EAR (ratio), so scale cancels out mostly.\n    // However, for velocity, we need consistent time.\n\n    const points: { x: number, y: number, z: number }[] = [];\n    for (let i = 0; i < landmarksArray.length; i += 3) {\n      points.push({\n        x: (landmarksArray[i] as number),\n        y: (landmarksArray[i + 1] as number),\n        z: (landmarksArray[i + 2] as number)\n      });\n    }\n\n    // --- ENGINE PROCESSING ---\n    const eyeState = eyeEngine.processFrame(points);\n    if (!eyeState) return null;\n\n    // --- Post-Processing & State Tracking ---\n\n    // Blink Counting (Rising Edge of isBlink)\n    // But engine.isBlink might be true for multiple frames.\n    // We want to count 'events'.\n    const now = Date.now();\n    if (eyeState.isBlink && !wasBlinking) {\n      blinkCount++;\n      wasBlinking = true;\n      lastBlinkTime = now;\n    } else if (!eyeState.isBlink) {\n      wasBlinking = false;\n    }\n\n    // Calculate Frequency\n    // Simple window: blinks in last minute? \n    // For now we just return a placeholder or accumulated\n    const blinkFrequency = 12; // Placeholder or calculate properly\n\n    // Drowsiness Decision\n    // Use the engine's rigorous classification\n    // We remove the explicit >30 check because normal blinks drop below 30 but shouldn't trigger \"Not Alert\" status\n    // unless the engine detects microsleep or drowsiness patterns.\n    const isAlert = !eyeState.isDrowsy && !eyeState.isMicrosleep;\n\n    // Debug Log\n    if (debug.frameCount++ % 30 === 0) {\n      console.log(\"Biometric Eye State:\", {\n        openness: eyeState.opennessPercent.toFixed(1) + \"%\",\n        raw: eyeState.rawOpennessMetric.toFixed(3),\n        isBlink: eyeState.isBlink,\n        isMicrosleep: eyeState.isMicrosleep,\n        state: isAlert ? \"ALERT\" : \"DROWSY\"\n      });\n    }\n\n    return {\n      // Core Requirement: \"Continuous percentage (0-100)\"\n      alertnessScore: Math.round(eyeState.opennessPercent),\n\n      // Pass the raw EAR equivalent for legacy UI graphs if needed\n      // (normalized to 0-1 range approx for UI)\n      eyeAspectRatio: eyeState.rawOpennessMetric,\n\n      blinkCount,\n      blinkFrequency: 0, // detailed freq not implemented yet in new engine\n      isAlert,\n\n      // Placeholders\n      headTilt: null,\n      lookingAway: false,\n      yawning: false,\n      lastUpdated: now,\n    }\n\n  } catch (err) {\n    console.warn(\"FaceMesh detection failed:\", err)\n    return null\n  }\n}\n\n// ----------------- Hazard Detection -----------------\n\nimport { hazardGuard } from \"./hazard-guard\";\n\nconst HAZARD_MIN_CONFIDENCE = 0.20 // Lowered further for \"hard\" classes\n\nconst COCO_TO_HAZARD_CLASS: Record<string, HazardObjectClass> = {\n  person: \"pedestrian\",\n  bicycle: \"cyclist\",\n  car: \"vehicle\",\n  motorcycle: \"vehicle\",\n  airplane: \"other\",\n  bus: \"vehicle\",\n  train: \"vehicle\",\n  truck: \"vehicle\",\n  boat: \"other\",\n  // Aggressive Mapping for \"Fallen Trees\" / \"Road Obstacles\"\n  bench: \"fallen_tree\",  // Large horizontal object\n  chair: \"fallen_tree\",\n  couch: \"fallen_tree\",\n  bed: \"fallen_tree\",\n  diningtable: \"fallen_tree\",\n  pottedplant: \"fallen_tree\", // Bush/Small tree\n\n  // Aggressive Mapping for \"Potholes/Debris\"\n  // Using small low objects as proxies\n  backpack: \"pothole\", // Dark patches often look like bags\n  handbag: \"pothole\",\n  suitcase: \"debris\",\n  umbrella: \"debris\",\n  bottle: \"pothole\",\n  cup: \"pothole\",\n  bowl: \"pothole\",\n\n  // Animals\n  bird: \"animal\",\n  cat: \"animal\",\n  dog: \"dog\",\n  horse: \"animal_large\",\n  sheep: \"animal_large\",\n  cow: \"cow\",\n  elephant: \"animal_large\",\n  bear: \"bear\",\n  zebra: \"animal_large\",\n  giraffe: \"animal_large\",\n\n  // Misc Debris\n  traffic_light: \"other\", // could be hazard if red?\n  fire_hydrant: \"road_barrier\",\n  stop_sign: \"road_barrier\",\n  parking_meter: \"road_barrier\",\n  tie: \"other\",\n  frisbee: \"debris\",\n  skis: \"debris\",\n  snowboard: \"debris\",\n  sports_ball: \"debris\",\n  kite: \"debris\",\n  baseball_bat: \"debris\",\n  baseball_glove: \"debris\",\n  skateboard: \"debris\",\n  surfboard: \"debris\",\n  tennis_racket: \"debris\",\n  wine_glass: \"debris\",\n  fork: \"debris\",\n  knife: \"debris\",\n  spoon: \"debris\",\n  banana: \"debris\",\n  apple: \"debris\",\n  sandwich: \"debris\",\n  orange: \"debris\",\n  broccoli: \"debris\",\n  carrot: \"debris\",\n  hot_dog: \"debris\",\n  pizza: \"debris\",\n  donut: \"debris\",\n  cake: \"debris\",\n  toilet: \"debris\",\n  tv: \"debris\",\n  laptop: \"debris\",\n  mouse: \"debris\",\n  remote: \"debris\",\n  keyboard: \"debris\",\n  cell_phone: \"debris\",\n  microwave: \"debris\",\n  oven: \"debris\",\n  toaster: \"debris\",\n  sink: \"debris\",\n  refrigerator: \"debris\",\n  book: \"debris\",\n  clock: \"debris\",\n  vase: \"debris\",\n  scissors: \"debris\",\n  teddy_bear: \"debris\",\n  hair_drier: \"debris\",\n  toothbrush: \"debris\"\n}\n\nfunction mapToHazardClass(cls: string): HazardObjectClass {\n  // COCO classes use underscores or spaces depending on version, normalize\n  const normalized = cls.toLowerCase().replace(\" \", \"_\");\n  return COCO_TO_HAZARD_CLASS[normalized] ?? \"other\"\n}\n\nexport async function runRealHazardDetection(\n  videoEl: HTMLVideoElement | null\n): Promise<HazardDetection[]> {\n  if (!videoEl) return []\n  // await ensureTFReady(); // MediaPipe doesn't depend on global TF readiness same way? but we keep for FaceMesh\n  await loadModels()\n\n\n  const detector = getObjectDetector()\n  if (!detector) return []\n\n  try {\n    // MediaPipe requires timestamp\n    const now = Date.now()\n    const result = detector.detectForVideo(videoEl, now)\n\n    if (!result || !result.detections) return []\n\n    const rawHazards: HazardDetection[] = []\n\n    for (let i = 0; i < result.detections.length; i++) {\n      const det = result.detections[i];\n      const category = det.categories[0];\n\n      if (!category || category.score < HAZARD_MIN_CONFIDENCE) continue\n\n      const mappedClass = mapToHazardClass(category.categoryName?.toLowerCase() || 'unknown');\n\n      // Filter out 'other' immediately\n      if (mappedClass === 'other') continue;\n\n      // MediaPipe BBox is { originX, originY, width, height, angle } (pixels)\n      // We need to normalize to 0-1\n      const bbox = det.boundingBox;\n      if (!bbox) continue;\n\n      rawHazards.push({\n        id: `${now}-${i}`,\n        objectClass: mappedClass,\n        confidence: category.score,\n        // Severity Logic\n        severity: (mappedClass === 'pedestrian' || mappedClass === 'cow' || mappedClass === 'wrong_way_vehicle')\n          ? \"critical\" : \"high\",\n        bbox: {\n          x: bbox.originX / videoEl.videoWidth,\n          y: bbox.originY / videoEl.videoHeight,\n          width: bbox.width / videoEl.videoWidth,\n          height: bbox.height / videoEl.videoHeight\n        },\n        timestamp: now,\n      })\n    }\n\n    // --- PIPELINE STEP 2: HAZARD GUARD ---\n    const filteredHazards = hazardGuard.process(rawHazards, videoEl.videoWidth, videoEl.videoHeight);\n\n    return filteredHazards;\n  } catch (err) {\n    console.error(\"Hazard detection failed:\", err)\n    return []\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1591, "column": 0}, "map": {"version":3,"sources":["file:///C:/Projects/Vision-AI/app/dashboard/live/page.tsx"],"sourcesContent":["\"use client\"\n\nimport { useState, useRef, useCallback, useEffect } from \"react\"\nimport { motion } from \"framer-motion\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Switch } from \"@/components/ui/switch\"\nimport { Label } from \"@/components/ui/label\"\nimport { Progress } from \"@/components/ui/progress\"\nimport { Video, VideoOff, Eye, AlertTriangle, Volume2, VolumeX, Shield, Camera, Gauge } from \"lucide-react\"\nimport type { DVSERiskAssessment, DrowsinessMetrics, HazardDetection, SafetyStatus, AlertnessWindow } from \"@/lib/types\"\nimport { assessRisk, createAlertnessWindow, updateAlertnessWindow, getStatusColor } from \"@/lib/dvse/engine\"\nimport { runRealDrowsinessDetection, runRealHazardDetection } from \"@/lib/detection\"\n\nconst hazardLabels: Record<string, string> = {\n  cow: \"Cow\",\n  dog: \"Dog\",\n  buffalo: \"Buffalo\",\n  pothole: \"Pothole\",\n  debris: \"Debris\",\n  pedestrian: \"Pedestrian\",\n}\n\nexport default function LiveDetectionPage() {\n  const frontVideoRef = useRef<HTMLVideoElement>(null)\n  const rearVideoRef = useRef<HTMLVideoElement>(null)\n\n  const [frontCameraActive, setFrontCameraActive] = useState(false)\n  const [rearCameraActive, setRearCameraActive] = useState(false)\n  const [isProcessing, setIsProcessing] = useState(false)\n  const [soundEnabled, setSoundEnabled] = useState(true)\n\n  const [drowsiness, setDrowsiness] = useState<DrowsinessMetrics | null>(null)\n  const [hazards, setHazards] = useState<HazardDetection[]>([])\n  const [riskAssessment, setRiskAssessment] = useState<DVSERiskAssessment>({\n    overallStatus: \"safe\",\n    riskScore: 0,\n    alertnessRisk: 0,\n    hazardRisk: 0,\n    timestamp: Date.now(),\n    shouldAlert: false,\n    alertMessage: null,\n  })\n  const [alertnessWindow, setAlertnessWindow] = useState<AlertnessWindow>(() => createAlertnessWindow())\n  const [showAlert, setShowAlert] = useState(false)\n  const [alertHistory, setAlertHistory] = useState<{ time: Date; message: string; status: SafetyStatus }[]>([])\n  const audioRef = useRef<HTMLAudioElement | null>(null)\n\n  // // Simulate drowsiness detection\n  // const simulateDrowsinessDetection = useCallback((): DrowsinessMetrics => {\n  //   const baseAlertness = 75\n  //   const timeVariation = Math.sin(Date.now() / 15000) * 25\n  //   const randomVariation = (Math.random() - 0.5) * 15\n  //   const alertnessScore = Math.max(0, Math.min(100, baseAlertness + timeVariation + randomVariation))\n\n  //   return {\n  //     alertnessScore: Math.round(alertnessScore),\n  //     eyeAspectRatio: 0.2 + (alertnessScore / 100) * 0.15,\n  //     blinkCount: Math.floor(Math.random() * 20) + 10,\n  //     blinkFrequency: Math.floor(Math.random() * 10) + 12,\n  //     isAlert: alertnessScore >= 50,\n  //     headTilt: (Math.random() - 0.5) * 20,\n  //     lookingAway: Math.random() > 0.9,\n  //     yawning: Math.random() > 0.95,\n  //     lastUpdated: Date.now(),\n  //   }\n  // }, [])\n\n  // // Simulate hazard detection\n  // const simulateHazardDetection = useCallback((): HazardDetection[] => {\n  //   if (Math.random() > 0.7) return []\n\n  //   const classes: Array<keyof typeof hazardLabels> = [\"cow\", \"pothole\", \"debris\", \"pedestrian\", \"dog\"]\n  //   const detectedClass = classes[Math.floor(Math.random() * classes.length)]\n  //   const confidence = 0.6 + Math.random() * 0.35\n\n  //   const isCritical = [\"cow\", \"pedestrian\"].includes(detectedClass)\n  //   let severity: HazardDetection[\"severity\"] = \"low\"\n  //   if (isCritical && confidence > 0.8) severity = \"critical\"\n  //   else if (isCritical && confidence > 0.6) severity = \"high\"\n  //   else if (confidence > 0.8) severity = \"high\"\n  //   else if (confidence > 0.6) severity = \"medium\"\n\n  //   return [\n  //     {\n  //       id: `${Date.now()}`,\n  //       objectClass: detectedClass,\n  //       confidence,\n  //       severity,\n  //       bbox: {\n  //         x: 0.2 + Math.random() * 0.4,\n  //         y: 0.3 + Math.random() * 0.3,\n  //         width: 0.15 + Math.random() * 0.1,\n  //         height: 0.2 + Math.random() * 0.1,\n  //       },\n  //       timestamp: Date.now(),\n  //     },\n  //   ]\n  // }, [])\n\n  // Main detection loop\n  const runDetection = useCallback(async () => {\n    try {\n      // 1) Real drowsiness from front camera\n      const newDrowsiness = await runRealDrowsinessDetection(frontVideoRef.current)\n      if (newDrowsiness) {\n        setDrowsiness(newDrowsiness)\n        const newWindow = updateAlertnessWindow(alertnessWindow, newDrowsiness.alertnessScore)\n        setAlertnessWindow(newWindow)\n      } else {\n        // if no face detected, you may choose to slowly degrade alertness or keep previous value\n        const newWindow = updateAlertnessWindow(alertnessWindow, alertnessWindow.average) // keep same\n        setAlertnessWindow(newWindow)\n      }\n\n      // 2) Real hazard detection from rear camera\n      let newHazards: HazardDetection[] = []\n      if (rearCameraActive) {\n        newHazards = await runRealHazardDetection(rearVideoRef.current)\n        setHazards(newHazards)\n      } else {\n        setHazards([])\n      }\n\n      // 3) Assess risk using existing engine\n      const assessment = assessRisk(newDrowsiness, newHazards, alertnessWindow.average)\n      setRiskAssessment(assessment)\n\n      // 4) Alert logic (reuse your existing logic)\n      if (assessment.shouldAlert && !showAlert) {\n        setShowAlert(true)\n        setAlertHistory((prev) => [\n          ...prev.slice(-9),\n          {\n            time: new Date(),\n            message: assessment.alertMessage || \"Alert triggered\",\n            status: assessment.overallStatus,\n          },\n        ])\n\n        if (soundEnabled && audioRef.current) {\n          audioRef.current.play().catch(() => { })\n        }\n\n        setTimeout(() => setShowAlert(false), 5000)\n      }\n\n      // 5) Draw detections on canvas (placeholder - integrate with canvas if needed)\n      drawDetections(newHazards)\n    } catch (err) {\n      console.error(\"runDetection error\", err)\n    }\n  }, [alertnessWindow, showAlert, soundEnabled, rearCameraActive])\n\n  // Simple placeholder for drawing detections; extend with canvas rendering as needed\n  const drawDetections = (detections: HazardDetection[]) => {\n    // No-op for now; keep for future visualization logic\n  }\n\n  // Toggle front camera\n  const toggleFrontCamera = async () => {\n    if (frontCameraActive) {\n      const stream = frontVideoRef.current?.srcObject as MediaStream\n      stream?.getTracks().forEach((track) => track.stop())\n      if (frontVideoRef.current) frontVideoRef.current.srcObject = null\n      setFrontCameraActive(false)\n    } else {\n      try {\n        const stream = await navigator.mediaDevices.getUserMedia({\n          video: { facingMode: \"user\", width: 640, height: 480 },\n        })\n        if (frontVideoRef.current) {\n          frontVideoRef.current.srcObject = stream\n          setFrontCameraActive(true)\n        }\n      } catch (err) {\n        console.error(\"Front camera access failed:\", err)\n      }\n    }\n  }\n\n  // Toggle rear camera\n  const toggleRearCamera = async () => {\n    if (rearCameraActive) {\n      const stream = rearVideoRef.current?.srcObject as MediaStream\n      stream?.getTracks().forEach((track) => track.stop())\n      if (rearVideoRef.current) rearVideoRef.current.srcObject = null\n      setRearCameraActive(false)\n    } else {\n      try {\n        const stream = await navigator.mediaDevices.getUserMedia({\n          video: { facingMode: \"environment\", width: 1280, height: 720 },\n        })\n        if (rearVideoRef.current) {\n          rearVideoRef.current.srcObject = stream\n          setRearCameraActive(true)\n        }\n      } catch (err) {\n        console.error(\"Rear camera access failed:\", err)\n      }\n    }\n  }\n\n  useEffect(() => {\n    if (!isProcessing) return\n    const interval = setInterval(runDetection, 500)\n    return () => clearInterval(interval)\n  }, [isProcessing, runDetection])\n\n  const getStatusDisplay = (status: SafetyStatus) => {\n    switch (status) {\n      case \"safe\":\n        return { label: \"SAFE\", bg: \"bg-success\", text: \"text-success\" }\n      case \"caution\":\n        return { label: \"CAUTION\", bg: \"bg-warning\", text: \"text-warning\" }\n      case \"high-risk\":\n        return { label: \"HIGH RISK\", bg: \"bg-destructive\", text: \"text-destructive\" }\n    }\n  }\n\n  const statusDisplay = getStatusDisplay(riskAssessment.overallStatus)\n\n  return (\n    <div className=\"space-y-6\">\n      <audio ref={audioRef} preload=\"auto\" />\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Vision-AI Live</h1>\n          <p className=\"text-muted-foreground\">Real-time drowsiness and hazard monitoring</p>\n        </div>\n        <Button onClick={() => setIsProcessing(!isProcessing)} variant={isProcessing ? \"destructive\" : \"default\"}>\n          {isProcessing ? \"Stop Vision-AI\" : \"Start Vision-AI\"}\n        </Button>\n      </div>\n\n      {/* Risk Banner */}\n      <motion.div\n        className={`p-4 rounded-xl border ${riskAssessment.overallStatus === \"high-risk\"\n            ? \"border-destructive bg-destructive/10\"\n            : riskAssessment.overallStatus === \"caution\"\n              ? \"border-warning bg-warning/10\"\n              : \"border-success bg-success/10\"\n          }`}\n      >\n        <div className=\"flex items-center gap-4\">\n          <div className={`h-12 w-12 rounded-full flex items-center justify-center ${statusDisplay.bg}`}>\n            <Shield className=\"h-6 w-6 text-white\" />\n          </div>\n          <div>\n            <div className={`text-xl font-bold ${statusDisplay.text}`}>{statusDisplay.label}</div>\n            <div className=\"text-sm text-muted-foreground\">Risk Score: {riskAssessment.riskScore}%</div>\n          </div>\n        </div>\n      </motion.div>\n\n      <div className=\"grid lg:grid-cols-2 gap-6\">\n        {/* Front Camera */}\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Eye className=\"h-5 w-5 text-primary\" />\n                <div>\n                  <CardTitle>Front Camera</CardTitle>\n                  <CardDescription>Driver Alertness</CardDescription>\n                </div>\n              </div>\n              <Button onClick={toggleFrontCamera} variant={frontCameraActive ? \"destructive\" : \"outline\"} size=\"sm\">\n                {frontCameraActive ? <VideoOff className=\"h-4 w-4\" /> : <Video className=\"h-4 w-4\" />}\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <div className=\"relative aspect-video bg-secondary/30\">\n              <video ref={frontVideoRef} autoPlay playsInline muted className=\"w-full h-full object-cover\" />\n              {!frontCameraActive && (\n                <div className=\"absolute inset-0 flex items-center justify-center\">\n                  <Eye className=\"h-12 w-12 text-muted-foreground/30\" />\n                </div>\n              )}\n              {frontCameraActive && drowsiness && (\n                <div className=\"absolute bottom-4 left-4 right-4 bg-background/80 backdrop-blur rounded-lg p-3\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <span className=\"text-sm\">Alertness</span>\n                    <span className={`font-bold ${getStatusColor(riskAssessment.overallStatus)}`}>\n                      {Math.round(alertnessWindow.average)}%\n                    </span>\n                  </div>\n                  <Progress value={alertnessWindow.average} className=\"h-2\" />\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Rear Camera */}\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-warning\" />\n                <div>\n                  <CardTitle>Rear Camera</CardTitle>\n                  <CardDescription>Road Hazards</CardDescription>\n                </div>\n              </div>\n              <Button onClick={toggleRearCamera} variant={rearCameraActive ? \"destructive\" : \"outline\"} size=\"sm\">\n                {rearCameraActive ? <VideoOff className=\"h-4 w-4\" /> : <Camera className=\"h-4 w-4\" />}\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <div className=\"relative aspect-video bg-secondary/30\">\n              <video ref={rearVideoRef} autoPlay playsInline muted className=\"w-full h-full object-cover\" />\n              {!rearCameraActive && (\n                <div className=\"absolute inset-0 flex items-center justify-center\">\n                  <Camera className=\"h-12 w-12 text-muted-foreground/30\" />\n                </div>\n              )}\n              {rearCameraActive && hazards.length > 0 && (\n                <div className=\"absolute top-4 right-4\">\n                  <Badge variant=\"destructive\" className=\"animate-pulse\">\n                    {hazards.length} Hazard Detected\n                  </Badge>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Bottom Controls */}\n      <div className=\"grid lg:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Gauge className=\"h-5 w-5\" />\n              Risk Meter\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className={`text-4xl font-bold text-center mb-4 ${getStatusColor(riskAssessment.overallStatus)}`}>\n              {riskAssessment.riskScore}%\n            </div>\n            <div className=\"h-3 rounded-full bg-gradient-to-r from-success via-warning to-destructive\" />\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Active Hazards</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {hazards.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground text-center py-4\">No hazards detected</p>\n            ) : (\n              <div className=\"space-y-2\">\n                {hazards.map((h) => (\n                  <div key={h.id} className=\"p-2 rounded-lg bg-warning/10 border border-warning/20\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"font-medium\">{hazardLabels[h.objectClass]}</span>\n                      <span className=\"text-sm\">{Math.round(h.confidence * 100)}%</span>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Settings</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                {soundEnabled ? <Volume2 className=\"h-4 w-4\" /> : <VolumeX className=\"h-4 w-4\" />}\n                <Label>Alert Sounds</Label>\n              </div>\n              <Switch checked={soundEnabled} onCheckedChange={setSoundEnabled} />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  )\n}\n"],"names":[],"mappings":"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"}}]
}